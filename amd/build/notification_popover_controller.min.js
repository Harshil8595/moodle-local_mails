define ("local_mails/notification_popover_controller",["jquery","core/ajax","core/templates","core/str","core/url","core/notification","core/custom_interaction_events","core/popover_region_controller","local_mails/notification_repository","local_mails/notification_area_events","message_popup/notification_popover_controller"],function(a,b,c,d,e,f,g,h,i,j,k){var l={MARK_ALL_READ_BUTTON:"[data-action=\"mails-mark-all-read\"]",ALL_NOTIFICATIONS_CONTAINER:"[data-region=\"mails-all-notifications\"]",NOTIFICATION:"[data-region=\"mails-content-item-container\"]",UNREAD_NOTIFICATION:"[data-region=\"mails-content-item-container\"].unread",NOTIFICATION_LINK:"[data-action=\"mails-content-item-link\"]",EMPTY_MESSAGE:"[data-region=\"mails-empty-message\"]",COUNT_CONTAINER:"[data-region=\"mails-count-container\"]"},m=function(a){h.call(this,a);this.markAllReadButton=this.root.find(l.MARK_ALL_READ_BUTTON);this.unreadCount=0;this.lastQueried=0;this.userId=this.root.attr("data-userid");this.container=this.root.find(l.ALL_NOTIFICATIONS_CONTAINER);this.limit=20;this.offset=0;this.loadedAll=!1;this.initialLoad=!1;this.unreadCount=this.root.find(l.COUNT_CONTAINER).html()};m.prototype=Object.create(k.prototype);m.prototype.constructor=m;m.prototype.renderUnreadCount=function(){var b=a(document).find(l.COUNT_CONTAINER);if(this.unreadCount&&0<this.unreadCount){b.text(this.unreadCount);b.removeClass("hidden")}else{b.addClass("hidden")}};m.prototype.hideUnreadCount=function(){this.root.find(l.COUNT_CONTAINER).addClass("hidden")};m.prototype.getNotificationElement=function(a){var b=this.root.find(l.NOTIFICATION+"[data-id=\""+a+"\"]");return 1==b.length?b:null};m.prototype.renderNotifications=function(b,d){var f=[];a.each(b,function(a,b){var d=this.getOffset()-this.limit;b.viewmoreurl=e.relativeUrl("/local/mails/index.php",{id:b.id,offset:d});var g={id:b.id};b.contexturl=e.relativeUrl("/local/mails/mark_mail_read.php",g);var h=c.render("local_mails/notification_content_item",b).then(function(a,b){return{html:a,js:b}});f.push(h)}.bind(this));return a.when.apply(a,f).then(function(){a.each(arguments,function(a,b){d.append(b.html);c.runTemplateJS(b.js)})})};m.prototype.markAllAsRead=function(){this.markAllReadButton.addClass("loading");var a={useridto:this.userId,timecreatedto:this.lastQueried};return i.markAllAsRead(a).then(function(){this.unreadCount=0;this.root.find(l.UNREAD_NOTIFICATION).removeClass("unread")}.bind(this)).always(function(){this.markAllReadButton.removeClass("loading")}.bind(this))};m.prototype.registerEventListeners=function(){g.define(this.root,[g.events.activate]);this.root.on(g.events.activate,l.MARK_ALL_READ_BUTTON,function(a,b){this.markAllAsRead();a.stopPropagation();b.originalEvent.preventDefault()}.bind(this));this.root.on(g.events.activate,l.NOTIFICATION_LINK,function(b){var c=a(b.target).closest(l.NOTIFICATION);if(c.hasClass("unread")){this.unreadCount--;c.removeClass("unread")}b.stopPropagation()}.bind(this));this.root.on(this.events().menuOpened,function(){this.hideUnreadCount();this.updateButtonAriaLabel();if(!this.hasDoneInitialLoad()){this.loadMoreNotifications()}}.bind(this));this.root.on(this.events().menuClosed,function(){this.renderUnreadCount();this.updateButtonAriaLabel()}.bind(this));this.root.on(this.events().startLoading,function(){this.getContent().attr("aria-busy","true")}.bind(this));this.root.on(this.events().stopLoading,function(){this.getContent().attr("aria-busy","false")}.bind(this));this.getContentContainer().on(g.events.scrollBottom,function(){if(!this.isLoading&&!this.hasLoadedAllContent()){this.loadMoreNotifications()}}.bind(this));g.define(this.getContentContainer(),[g.events.scrollLock]);a(document).on(j.notificationShown,function(a,b){if(!b.read){var c=this.getNotificationElement(b.id);if(c){c.removeClass("unread")}this.unreadCount--;this.renderUnreadCount()}}.bind(this))};return m});
//# sourceMappingURL=notification_popover_controller.min.js.map
